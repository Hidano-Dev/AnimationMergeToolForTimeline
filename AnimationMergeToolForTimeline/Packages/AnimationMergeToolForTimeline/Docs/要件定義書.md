# Animation Merge Tool for Timeline 要件定義書

**文書バージョン**: 1.1
**作成日**: 2026-01-25
**更新日**: 2026-01-27
**対象Unityバージョン**: 6000.0.64f1

---

## 1. 概要

### 1.1 目的

本ツールは、UnityのTimeline上で複数トラックにまたがり構成されたAnimationTrackの内容をマージし、単一のAnimationClipアセットとして出力するEditor拡張ツールである。

### 1.2 背景

Timelineシステムでは、AnimationTrackが下の段になるほど優先的にOverrideされる。同一のAnimationPropertyが複数存在する場合、クリップが重なっている区間では下の段のAnimationCurveが優先され、重なっていない区間の挙動は各クリップのAnimationExtrapolation設定によって決定される。本ツールは、この挙動を再現し、Timelineを再生したときと全く同じ状態のアニメーションを単一のAnimationClipに統合することを目的とする。

### 1.3 適用範囲

- Unityエディタ上でのみ動作するEditor拡張
- Unity 6 (6000.0.64f1) 環境

---

## 2. 機能要件

### 2.1 起動方法

| ID | 要件 |
|----|------|
| FR-001 | HierarchyビューでPlayableDirectorを右クリックした際のコンテキストメニューから実行可能であること |
| FR-002 | ProjectビューでTimelineAssetを右クリックした際のコンテキストメニューから実行可能であること |
| FR-003 | 複数のPlayableDirectorまたはTimelineAssetを選択した場合、選択された各アセットに対して順次処理を実行すること |
| FR-004 | コンテキストメニューには「Merge Timeline Animations」（AnimationClip出力）と「Merge Timeline Animations to FBX」（FBX出力）の2つのオプションを提供すること |

### 2.2 トラック検出

| ID | 要件 |
|----|------|
| FR-010 | 選択されたTimelineAssetから、同一のAnimatorがバインドされているAnimationTrackおよびOverrideTrackを検出すること |
| FR-011 | OverrideTrackはScript上ではAnimationTrackと同一だが、親となるAnimationTrackのバインド情報がフォールダウンされているトラックとして扱うこと |
| FR-012 | Muteに設定されているトラックはマージ処理の対象外とすること |
| FR-013 | バインドされていないトラック（Animator未設定）はスキップし、エラーログを出力すること |

### 2.3 優先順位の決定

| ID | 要件 |
|----|------|
| FR-020 | トラックの優先順位は、Timeline上での位置に基づき、下にあるトラックほど優先順位が高いこと |
| FR-021 | TrackGroup内に階層構造がある場合も、同様に下にあるものほど優先順位が高いこと |

### 2.4 クリップ統合処理

| ID | 要件 |
|----|------|
| FR-030 | 同一トラック内に配置された複数のAnimationClipは全て統合対象とすること |
| FR-031 | 各クリップのTimeline上における配置タイミング（開始位置・終了位置）を維持したまま統合すること |
| FR-032 | クリップ間のGap（空白区間）は、タイミングが早い方のクリップのAnimationExtrapolation設定に従って処理すること |

### 2.5 Override動作

| ID | 要件 |
|----|------|
| FR-040 | 同一AnimationPropertyが複数トラックに存在する場合、下の段（優先順位が高い）のAnimationCurveで上の段をOverrideすること |
| FR-041 | 下の段のクリップが上の段のクリップと部分的にしか重ならない場合、下の段のクリップのAnimationExtrapolation設定に従って処理すること |
| FR-042 | AnimationExtrapolationの種類（None/Hold/Loop/PingPong/Continue）に応じた適切な補間処理を行うこと |

### 2.6 ブレンド処理

| ID | 要件 |
|----|------|
| FR-050 | クリップのEaseIn/EaseOut（ブレンド）を正しく処理すること |
| FR-051 | 各クリップのBlendCurvesのIn/Outを使用してブレンド処理を行うこと |

### 2.7 出力仕様

| ID | 要件 |
|----|------|
| FR-060 | 1つのTimelineAssetに複数のAnimatorに対応したAnimationTrackが含まれている場合、バインドされているAnimator単位でそれぞれ別のAnimationClipを出力すること |
| FR-061 | 生成されるAnimationClipのファイル名は「{TimelineAsset名}_{Animator名}_Merged.anim」とすること |
| FR-062 | 保存先はAssetsフォルダ直下に固定すること |
| FR-063 | 同名ファイルが存在する場合、上書きせず「(1)」「(2)」等の連番を付与した重複しない名前で保存すること（ファイル名にスペース文字を含めないこと） |
| FR-064 | 出力AnimationClipのフレームレートはTimeline設定に合わせること |

### 2.8 対応プロパティ

| ID | 要件 |
|----|------|
| FR-070 | ルートモーションのプロパティを含めること |
| FR-071 | Humanoidリグのマッスルカーブが設定されている場合は対応すること |
| FR-072 | BlendShape（モーフターゲット）のアニメーションカーブが設定されている場合は対応すること |

### 2.9 FBXエクスポート機能

| ID | 要件 |
|----|------|
| FR-080 | マージしたアニメーションデータをFBX形式で出力できること |
| FR-081 | FBX出力には、バインドされたAnimatorのスケルトン（ボーン階層）が存在する場合は含めること |
| FR-082 | FBX出力には、スケルトン以外のGameObjectのTransformアニメーションも含めること（小物、エフェクト用オブジェクト等） |
| FR-083 | FBX出力には、マージされたアニメーションカーブを含めること |
| FR-084 | FBX出力には、BlendShape（モーフターゲット）のアニメーションカーブを含めること |
| FR-085 | 生成されるFBXファイル名は「{TimelineAsset名}_{Animator名}_Merged.fbx」とすること |
| FR-086 | FBXの保存先はAssetsフォルダ直下に固定すること |
| FR-087 | 同名FBXファイルが存在する場合、上書きせず「(1)」「(2)」等の連番を付与した重複しない名前で保存すること |
| FR-088 | FBX出力は他のゲームエンジン（Unreal Engine、Godot等）へのインポートを主な用途として想定すること |
| FR-089 | Unity公式のFBX Exporterパッケージ（com.unity.formats.fbx）を使用して実装すること |
| FR-090 | FBX出力は常にGeneric形式とすること（Humanoidリグは使用しない） |
| FR-091 | ソースAnimatorのRigがHumanoidの場合、Humanoidボーン名を対応するTransformのパスに変換してエクスポートすること |
| FR-092 | FBX出力時、ルートモーションが含まれる場合は適切にエクスポートすること |

---

## 3. 非機能要件

### 3.1 アーキテクチャ

| ID | 要件 |
|----|------|
| NFR-001 | AnimationClipデータを生成する機能と、アセットファイルを作成する機能を明確に分離すること（将来の拡張性考慮） |
| NFR-002 | C# 9.0/.NET Framework 4.7.1に準拠すること |
| NFR-003 | FBXエクスポート機能はUnity公式パッケージ（com.unity.formats.fbx）に依存すること |
| NFR-004 | FBXエクスポート機能は既存のAnimationClip生成ロジックを再利用し、出力部分のみを差し替える設計とすること |

### 3.2 保守性

| ID | 要件 |
|----|------|
| NFR-010 | エディタ専用コードはEditorフォルダ配下に配置すること |
| NFR-011 | ランタイムとエディタのコードを明確に分離すること |

---

## 4. UI/UX要件

| ID | 要件 |
|----|------|
| UX-001 | 処理中はプログレス表示を行うこと |
| UX-002 | 処理の成功/失敗はConsoleに出力すること |

---

## 5. エラー処理

| ID | 条件 | 処理 |
|----|------|------|
| ERR-001 | バインドされていないトラック（Animator未設定）が存在する | エラーログを出力し、該当トラックをスキップして処理を継続 |
| ERR-002 | 対象となるトラックが0件 | エラーログを出力し、処理を終了 |
| ERR-003 | FBX Exporterパッケージ（com.unity.formats.fbx）がインストールされていない | エラーダイアログを表示し、パッケージのインストールを促す |
| ERR-004 | FBXエクスポート時にエクスポート可能なデータ（スケルトン、BlendShape、Transformアニメーション）がない | エラーログを出力し、該当Animatorのエクスポートをスキップして処理を継続 |

---

## 6. 制約事項

| ID | 制約 |
|----|------|
| CON-001 | 本バージョンではマージ対象のトラック選択機能は提供しない |
| CON-002 | 本バージョンでは時間範囲を指定してマージする機能は提供しない |
| CON-003 | 保存先フォルダの指定機能は提供しない（Assetsフォルダ直下固定） |
| CON-004 | FBXエクスポート機能はUnity公式FBX Exporterパッケージ（com.unity.formats.fbx）の事前インストールが必要 |
| CON-005 | FBXエクスポートはスケルトン、BlendShape、またはTransformアニメーションのいずれかを持つAnimatorを対象とする |

---

## 7. 将来の拡張予定

以下の機能は将来のバージョンで検討する：

- マージ対象トラックのユーザー選択機能
- 時間範囲指定によるマージ機能
- 保存先フォルダの指定機能
- FBXエクスポート時のオプション設定（座標系、スケール単位等）

---

## 8. 用語定義

| 用語 | 定義 |
|------|------|
| AnimationTrack | Timeline上でアニメーションクリップを配置するトラック |
| OverrideTrack | AnimationTrackの子として作成され、親のバインド情報を継承するトラック |
| AnimationExtrapolation | クリップの範囲外における動作を定義する設定（None/Hold/Loop/PingPong/Continue） |
| BlendCurves | クリップのEaseIn/EaseOutのブレンドカーブ |
| Mute | トラックの出力を無効化する設定 |
| FBX | Autodesk社が開発した3Dデータ交換用ファイル形式。スケルトン、メッシュ、アニメーションを含むことができる |
| スケルトン | アニメーション対象となるボーン（骨格）の階層構造 |
| FBX Exporter | Unity公式のFBXファイル出力パッケージ（com.unity.formats.fbx） |
| BlendShape | メッシュの頂点を変形させるモーフターゲット機能。表情アニメーション等に使用される。FBXではMorph Targetとも呼ばれる |
| Generic | Unityのアニメーションリグタイプの一つ。Humanoid以外の汎用的なボーン構造を扱う形式 |

---

## 更新履歴

| バージョン | 日付 | 変更内容 |
|------------|------|----------|
| 1.0 | 2026-01-25 | 初版作成 |
| 1.1 | 2026-01-27 | FBXエクスポート機能の要件を追加（FR-004, FR-072, FR-080～FR-092, NFR-003～NFR-004, ERR-003～ERR-004, CON-004～CON-005）。BlendShape対応要件を追加。Humanoid→Generic変換仕様を明確化 |
