# Animation Merge Tool for Timeline 開発計画書

**文書バージョン**: 1.1
**作成日**: 2026-01-25
**更新日**: 2026-01-27
**対象要件定義書**: 要件定義書.md v1.1

---

## 1. 開発方針

### 1.1 基本方針

- テスト駆動開発（TDD）を採用し、各機能の実装前にテストを作成
- 機能を小さな単位に分割し、段階的に統合
- クリップデータ生成とアセット保存の責務を明確に分離（NFR-001対応）

### 1.2 開発環境

| 項目 | 内容 |
|------|------|
| Unity バージョン | 6000.0.64f1 |
| C# バージョン | 9.0 |
| .NET Framework | 4.7.1 |
| 推奨IDE | JetBrains Rider |

---

## 2. アーキテクチャ設計

### 2.1 レイヤー構成

```
┌─────────────────────────────────────────────────────────┐
│                    UI Layer (Editor)                     │
│  - ContextMenuHandler: コンテキストメニュー登録          │
│  - ProgressDisplay: 進捗表示                            │
└─────────────────────────────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────┐
│                  Application Layer                       │
│  - AnimationMergeService: マージ処理のオーケストレーション│
└─────────────────────────────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────┐
│                    Domain Layer                          │
│  - TrackAnalyzer: トラック検出・優先順位決定             │
│  - ClipMerger: クリップ統合処理                         │
│  - ExtrapolationProcessor: Extrapolation処理            │
│  - BlendProcessor: ブレンド処理                         │
│  - CurveOverrider: Override処理                         │
└─────────────────────────────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────┐
│                Infrastructure Layer                      │
│  - AnimationClipExporter: AnimationClipアセット保存      │
│  - FbxAnimationExporter: FBX形式でのエクスポート         │
│  - HumanoidToGenericConverter: Humanoid→Generic変換     │
│  - FileNameGenerator: ファイル名生成                     │
└─────────────────────────────────────────────────────────┘
```

### 2.2 主要クラス設計

#### 2.2.1 Domain Layer

| クラス名 | 責務 | 対応要件 |
|----------|------|----------|
| `TrackAnalyzer` | TimelineAssetからAnimationTrackを検出し、優先順位を決定 | FR-010〜FR-021 |
| `ClipMerger` | 複数のクリップを単一のAnimationClipに統合 | FR-030〜FR-032 |
| `ExtrapolationProcessor` | AnimationExtrapolation設定に基づく補間処理 | FR-041, FR-042 |
| `BlendProcessor` | EaseIn/EaseOutのブレンド処理 | FR-050, FR-051 |
| `CurveOverrider` | 優先順位に基づくAnimationCurveのOverride処理 | FR-040, FR-041 |

#### 2.2.2 Infrastructure Layer

| クラス名 | 責務 | 対応要件 |
|----------|------|----------|
| `AnimationClipExporter` | AnimationClipアセットの保存 | FR-060〜FR-063 |
| `FbxAnimationExporter` | FBX形式でのアニメーションエクスポート | FR-080〜FR-092 |
| `HumanoidToGenericConverter` | HumanoidボーンからTransformパスへの変換 | FR-090, FR-091 |
| `FileNameGenerator` | 出力ファイル名の生成・重複回避 | FR-061, FR-063, FR-085, FR-087 |

#### 2.2.3 Data Transfer Objects

| クラス名 | 用途 |
|----------|------|
| `TrackInfo` | トラック情報（優先順位、バインド情報等）を保持 |
| `ClipInfo` | クリップ情報（開始/終了時間、Extrapolation設定等）を保持 |
| `MergeResult` | マージ結果（生成されたAnimationClipデータ）を保持 |
| `FbxExportData` | FBXエクスポート用のデータ（スケルトン、カーブ等）を保持 |

---

## 3. 開発フェーズ

### Phase 1: 基盤構築

**目標**: プロジェクト構造の整備と基本的なトラック検出機能の実装

**対応要件**: FR-010〜FR-013, NFR-010, NFR-011

**成果物**:
- アセンブリ定義ファイル（Editor/Runtime分離）
- `TrackAnalyzer` クラス
- `TrackInfo` データクラス
- 単体テスト

**タスク**:
1. Editorアセンブリ定義ファイル作成
2. TrackAnalyzerの実装
   - AnimationTrack検出
   - OverrideTrack検出
   - Muteトラックのフィルタリング
   - バインドされていないトラックの検出とログ出力
3. 単体テスト作成

---

### Phase 2: 優先順位決定

**目標**: トラックの優先順位決定ロジックの実装

**対応要件**: FR-020, FR-021

**成果物**:
- `TrackAnalyzer` への優先順位決定機能追加
- 単体テスト

**タスク**:
1. Timeline上の位置に基づく優先順位計算
2. TrackGroup内の階層構造対応
3. 単体テスト作成

---

### Phase 3: 基本的なクリップ統合

**目標**: 単一トラック内のクリップ統合機能の実装

**対応要件**: FR-030, FR-031, FR-064

**成果物**:
- `ClipMerger` クラス
- `ClipInfo` データクラス
- 単体テスト

**タスク**:
1. ClipInfoデータクラス作成
2. ClipMergerの実装
   - AnimationCurveの時間オフセット適用
   - フレームレート設定
3. 単体テスト作成

---

### Phase 4: Extrapolation処理

**目標**: クリップ間のGapおよびExtrapolation処理の実装

**対応要件**: FR-032, FR-041, FR-042

**成果物**:
- `ExtrapolationProcessor` クラス
- 単体テスト

**タスク**:
1. ExtrapolationProcessorの実装
   - None: 値なし
   - Hold: 最終値を維持
   - Loop: ループ再生
   - PingPong: 往復再生
   - Continue: カーブの傾きを維持
2. 各Extrapolationタイプの単体テスト作成

---

### Phase 5: ブレンド処理

**目標**: EaseIn/EaseOutブレンド処理の実装

**対応要件**: FR-050, FR-051

**成果物**:
- `BlendProcessor` クラス
- 単体テスト

**タスク**:
1. BlendProcessorの実装
   - BlendCurvesの取得
   - ブレンドウェイト計算
   - カーブ値のブレンド
2. 単体テスト作成

---

### Phase 6: Override処理

**目標**: 複数トラック間のOverride処理の実装

**対応要件**: FR-040, FR-041

**成果物**:
- `CurveOverrider` クラス
- 単体テスト

**タスク**:
1. CurveOverriderの実装
   - 同一プロパティの検出
   - 優先順位に基づくカーブの選択/合成
   - 部分的重なりの処理
2. 単体テスト作成

---

### Phase 7: 出力機能

**目標**: AnimationClipアセットの保存機能の実装

**対応要件**: FR-060〜FR-063

**成果物**:
- `AnimationClipExporter` クラス
- `FileNameGenerator` クラス
- 単体テスト

**タスク**:
1. FileNameGeneratorの実装
   - 命名規則適用
   - 重複回避の連番付与
2. AnimationClipExporterの実装
   - AssetDatabase操作
3. 単体テスト作成

---

### Phase 8: UI/コンテキストメニュー

**目標**: コンテキストメニューからの実行機能の実装

**対応要件**: FR-001〜FR-003, UX-001, UX-002

**成果物**:
- `ContextMenuHandler` クラス
- `AnimationMergeService` クラス（オーケストレーション）
- 進捗表示機能

**タスク**:
1. ContextMenuHandlerの実装
   - Hierarchyビューメニュー登録
   - Projectビューメニュー登録
   - 複数選択対応
2. AnimationMergeServiceの実装
   - 各処理クラスの統合
   - 進捗表示
   - エラーハンドリング
3. 統合テスト作成

---

### Phase 9: 特殊プロパティ対応

**目標**: ルートモーション・Humanoidマッスルカーブ対応

**対応要件**: FR-070, FR-071

**成果物**:
- 各処理クラスへの特殊プロパティ対応追加
- 単体テスト

**タスク**:
1. ルートモーションプロパティの検出と処理
2. Humanoidマッスルカーブの検出と処理
3. 単体テスト作成

---

### Phase 10: エラー処理・最終調整

**目標**: エラー処理の強化と全体的な品質向上

**対応要件**: ERR-001, ERR-002

**成果物**:
- エラーハンドリング強化
- 統合テスト
- ドキュメント

**タスク**:
1. エラー処理の網羅的なテスト
2. エッジケースの対応
3. コードレビュー・リファクタリング
4. 使用方法ドキュメント作成

---

### Phase 11: BlendShape対応

**目標**: BlendShape（モーフターゲット）アニメーションカーブの対応

**対応要件**: FR-072

**成果物**:
- BlendShapeカーブの検出・処理機能
- 単体テスト

**タスク**:
1. BlendShape（モーフターゲット）アニメーションカーブの検出
2. BlendShapeカーブのマージ処理
3. 単体テスト作成

---

### Phase 12: FBXエクスポート基盤

**目標**: FBXエクスポート機能の基盤構築

**対応要件**: FR-004, FR-080, NFR-003, NFR-004, ERR-003

**成果物**:
- `FbxAnimationExporter` クラス
- `FbxExportData` データクラス
- FBX Exporterパッケージ存在チェック機能
- コンテキストメニューへのFBXオプション追加
- 単体テスト

**タスク**:
1. FBX Exporterパッケージ（com.unity.formats.fbx）の依存関係確認機能
   - パッケージ未インストール時のエラーダイアログ表示
2. FbxExportDataデータクラス作成
   - スケルトン情報保持
   - アニメーションカーブ情報保持
3. FbxAnimationExporterの基本実装
   - FBX Exporter APIのラッパー
   - 基本的なエクスポート処理
4. ContextMenuHandlerへのFBXオプション追加
5. 単体テスト作成

---

### Phase 13: スケルトン・Transform出力

**目標**: FBXへのスケルトンおよびTransformアニメーション出力

**対応要件**: FR-081, FR-082, FR-083

**成果物**:
- スケルトン階層の出力機能
- Transformアニメーション出力機能
- 単体テスト

**タスク**:
1. バインドされたAnimatorからスケルトン（ボーン階層）を取得
2. スケルトン以外のGameObjectのTransform情報を取得
3. Transformアニメーションカーブの出力
4. 単体テスト作成

---

### Phase 14: Humanoid→Generic変換

**目標**: HumanoidリグからGeneric形式への変換機能

**対応要件**: FR-090, FR-091, FR-092

**成果物**:
- `HumanoidToGenericConverter` クラス
- ルートモーション変換機能
- 単体テスト

**タスク**:
1. HumanoidToGenericConverterの実装
   - Humanoidボーン名からTransformパスへのマッピング
   - マッスルカーブからTransform回転への変換
2. ルートモーションのエクスポート対応
3. 単体テスト作成

---

### Phase 15: BlendShapeエクスポート

**目標**: BlendShapeアニメーションのFBXエクスポート対応

**対応要件**: FR-084, ERR-004

**成果物**:
- BlendShapeアニメーション出力機能
- エクスポートデータなし時のエラー処理
- 単体テスト

**タスク**:
1. BlendShape（モーフターゲット）カーブの検出
2. BlendShapeカーブのFBXエクスポート
3. エクスポート可能データなし時のエラー処理実装
4. 単体テスト作成

---

### Phase 16: FBXエクスポート統合・最終調整

**目標**: FBXエクスポート機能の統合テストと全体的な品質向上

**対応要件**: FR-085, FR-086, FR-087, FR-088, CON-004, CON-005

**成果物**:
- FBXエクスポート統合テスト
- ファイル名生成（.fbx対応）
- ドキュメント

**タスク**:
1. FileNameGeneratorのFBX対応（.fbx拡張子、重複回避）
2. AnimationMergeServiceへのFBXエクスポート統合
3. 統合テスト作成
   - 各種ゲームエンジンへのインポート検証（可能な範囲で）
4. エッジケースの対応
5. 使用方法ドキュメント作成

---

## 4. ディレクトリ構成

```
AnimationMergeToolForTimeline/
├── Assets/                              # 空（使用しない）
├── Packages/
│   └── AnimationMergeToolForTimeline/
│       ├── package.json                 # パッケージ定義
│       ├── Docs/
│       │   ├── 要件定義書.md
│       │   └── 開発計画書.md
│       ├── Scripts/
│       │   └── Editor/
│       │       ├── AnimationMergeTool.Editor.asmdef
│       │       ├── UI/
│       │       │   ├── ContextMenuHandler.cs
│       │       │   └── ProgressDisplay.cs
│       │       ├── Application/
│       │       │   └── AnimationMergeService.cs
│       │       ├── Domain/
│       │       │   ├── TrackAnalyzer.cs
│       │       │   ├── ClipMerger.cs
│       │       │   ├── ExtrapolationProcessor.cs
│       │       │   ├── BlendProcessor.cs
│       │       │   ├── CurveOverrider.cs
│       │       │   └── Models/
│       │       │       ├── TrackInfo.cs
│       │       │       ├── ClipInfo.cs
│       │       │       └── MergeResult.cs
│       │       └── Infrastructure/
│       │           ├── AnimationClipExporter.cs
│       │           ├── FbxAnimationExporter.cs
│       │           ├── HumanoidToGenericConverter.cs
│       │           ├── FileNameGenerator.cs
│       │           └── Models/
│       │               └── FbxExportData.cs
│       └── Tests/
│           └── Editor/
│               ├── AnimationMergeTool.Editor.Tests.asmdef
│               ├── TrackAnalyzerTests.cs
│               ├── ClipMergerTests.cs
│               ├── ExtrapolationProcessorTests.cs
│               ├── BlendProcessorTests.cs
│               ├── CurveOverriderTests.cs
│               ├── FileNameGeneratorTests.cs
│               ├── FbxAnimationExporterTests.cs
│               ├── HumanoidToGenericConverterTests.cs
│               └── IntegrationTests.cs
└── ProjectSettings/
```

---

## 5. テスト戦略

### 5.1 テストレベル

| レベル | 対象 | ツール |
|--------|------|--------|
| 単体テスト | 各クラスの個別機能 | Unity Test Framework (EditMode) |
| 統合テスト | 複数クラスの連携 | Unity Test Framework (EditMode) |
| E2Eテスト | コンテキストメニューからの全体フロー | Unity Test Framework (PlayMode) |

### 5.2 テストカバレッジ目標

- 単体テスト: 80%以上
- 統合テスト: 主要フロー100%

### 5.3 重点テスト項目

1. **Extrapolation処理**: 各タイプ（None/Hold/Loop/PingPong/Continue）の正確な動作
2. **Override処理**: 部分的重なりのケース
3. **ブレンド処理**: 複数クリップの連続ブレンド
4. **ファイル名生成**: 重複回避の連番付与（.anim/.fbx両対応）
5. **Humanoid→Generic変換**: ボーン名マッピングの正確性
6. **BlendShapeエクスポート**: モーフターゲットカーブの正確な出力
7. **FBXパッケージ依存**: パッケージ未インストール時のエラーハンドリング

---

## 6. 依存関係

### 6.1 外部依存

| パッケージ | バージョン | 用途 | 必須 |
|------------|------------|------|------|
| com.unity.timeline | 1.8.10 | Timeline API | 必須 |
| com.unity.test-framework | 1.6.0 | テスト実行 | 必須 |
| com.unity.formats.fbx | 5.x | FBXエクスポート | オプション（FBX出力時のみ必要） |

### 6.2 内部依存（実装順序）

```
Phase 1 (TrackAnalyzer)
    │
    ▼
Phase 2 (優先順位) ─────────────────────┐
    │                                   │
    ▼                                   │
Phase 3 (ClipMerger) ───┐               │
    │                   │               │
    ▼                   │               │
Phase 4 (Extrapolation) │               │
    │                   │               │
    ▼                   ▼               │
Phase 5 (Blend) ────────┴───────────────┤
    │                                   │
    ▼                                   ▼
Phase 6 (Override) ◄────────────────────┘
    │
    ▼
Phase 7 (Export)
    │
    ▼
Phase 8 (UI/Service)
    │
    ▼
Phase 9 (特殊プロパティ: ルートモーション、Humanoid)
    │
    ▼
Phase 10 (エラー処理・最終調整)
    │
    ▼
Phase 11 (BlendShape対応)
    │
    ▼
Phase 12 (FBXエクスポート基盤)
    │
    ▼
Phase 13 (スケルトン・Transform出力)
    │
    ▼
Phase 14 (Humanoid→Generic変換)
    │
    ▼
Phase 15 (BlendShapeエクスポート)
    │
    ▼
Phase 16 (FBXエクスポート統合・最終調整)
```

---

## 7. リスクと対策

| リスク | 影響度 | 対策 |
|--------|--------|------|
| AnimationCurveの精度問題 | 高 | フレームレートに基づくサンプリング間隔の適切な設定 |
| Extrapolation処理の複雑性 | 高 | 各タイプごとに独立したテストケースを作成 |
| パフォーマンス低下（大量カーブ） | 中 | 必要に応じてバッチ処理・最適化 |
| Timeline API変更 | 低 | Unity 6の安定版を使用、APIの抽象化 |
| Humanoid→Generic変換の複雑性 | 高 | Humanoidボーンマッピングの網羅的なテスト、Unity公式ドキュメント参照 |
| FBX Exporter APIの変更 | 中 | Unity公式パッケージの安定版を使用、APIをラップして抽象化 |
| 他ゲームエンジンとの互換性問題 | 中 | Generic形式採用による互換性確保、主要エンジンでのインポートテスト |
| BlendShapeのFBXエクスポート制限 | 中 | FBX Exporterの仕様を事前調査、制限事項をドキュメント化 |

---

## 8. 完了基準

### 8.1 AnimationClip出力機能（Phase 1〜10）

1. 機能要件FR-001〜FR-071が実装されていること
2. 非機能要件NFR-001〜NFR-002、NFR-010〜NFR-011が満たされていること
3. 単体テストカバレッジ80%以上
4. 統合テストが全てパスすること
5. エラー処理ERR-001〜ERR-002が実装されていること

### 8.2 BlendShape対応（Phase 11）

1. 機能要件FR-072が実装されていること
2. BlendShapeカーブのマージが正しく動作すること
3. 単体テストが全てパスすること

### 8.3 FBXエクスポート機能（Phase 12〜16）

1. 機能要件FR-080〜FR-092が実装されていること
2. 非機能要件NFR-003〜NFR-004が満たされていること
3. FBXエクスポート関連の単体テストカバレッジ80%以上
4. FBXエクスポートの統合テストが全てパスすること
5. エラー処理ERR-003〜ERR-004が実装されていること
6. 制約事項CON-004〜CON-005が適切に処理されていること

---

## 更新履歴

| バージョン | 日付 | 変更内容 |
|------------|------|----------|
| 1.0 | 2026-01-25 | 初版作成 |
| 1.1 | 2026-01-27 | 新機能の開発計画を追加。Phase 11: BlendShape対応、Phase 12〜16: FBXエクスポート機能。アーキテクチャにFbxAnimationExporter、HumanoidToGenericConverter等を追加。外部依存にcom.unity.formats.fbxを追加。テスト項目・リスク・完了基準を更新 |
