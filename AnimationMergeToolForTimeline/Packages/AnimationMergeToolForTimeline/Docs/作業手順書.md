# Animation Merge Tool for Timeline 作業手順書

**文書バージョン**: 1.0
**作成日**: 2026-01-25
**参照**: 開発計画書.md v1.0

---

## 使い方

各タスクの完了時に `[x]` でチェックを入れてください。
依存関係のあるタスクは、先行タスクの完了後に着手してください。

---

## Phase 1: 基盤構築

**目標**: プロジェクト構造の整備と基本的なトラック検出機能の実装
**対応要件**: FR-010〜FR-013, NFR-010, NFR-011

### 1.1 プロジェクト構造の作成

- [x] **1.1.1** パッケージディレクトリ構造の作成
  ```
  Packages/AnimationMergeToolForTimeline/
  ├── Scripts/
  │   └── Editor/
  │       ├── UI/
  │       ├── Application/
  │       ├── Domain/
  │       │   └── Models/
  │       └── Infrastructure/
  └── Tests/
      └── Editor/
  ```

- [x] **1.1.2** `package.json` の作成
  - パッケージ名: `com.hidano.animation-merge-tool`
  - バージョン: `0.1.0-preview.1`
  - 依存関係: `com.unity.timeline`

- [x] **1.1.3** Editorアセンブリ定義ファイルの作成
  - ファイル: `Scripts/Editor/AnimationMergeTool.Editor.asmdef`
  - プラットフォーム: Editor only
  - 参照: `Unity.Timeline`, `Unity.Timeline.Editor`

- [x] **1.1.4** テスト用アセンブリ定義ファイルの作成
  - ファイル: `Tests/Editor/AnimationMergeTool.Editor.Tests.asmdef`
  - 参照: `AnimationMergeTool.Editor`, `UnityEngine.TestRunner`, `UnityEditor.TestRunner`

### 1.2 データモデルの作成

- [x] **1.2.1** `TrackInfo.cs` の作成（`Domain/Models/`）
  ```csharp
  // 保持する情報:
  // - AnimationTrack参照
  // - 優先順位（int）
  // - バインドされたAnimator
  // - Mute状態
  // - 子トラック（OverrideTrack）のリスト
  ```

- [x] **1.2.2** `TrackInfo` の単体テスト作成

### 1.3 TrackAnalyzerの実装

- [x] **1.3.1** `TrackAnalyzer.cs` の作成（`Domain/`）

- [x] **1.3.2** AnimationTrack検出機能の実装
  - TimelineAssetから全AnimationTrackを取得
  - テスト作成・実行

- [x] **1.3.3** OverrideTrack検出機能の実装
  - 親トラックのバインド情報継承確認
  - テスト作成・実行

- [x] **1.3.4** Muteトラックフィルタリング機能の実装
  - `track.muted` プロパティのチェック
  - テスト作成・実行

- [x] **1.3.5** バインドなしトラック検出機能の実装
  - Animator未設定トラックの検出
  - Debug.LogError出力
  - テスト作成・実行

### 1.4 Phase 1 完了確認

- [x] **1.4.1** 全テストがパスすることを確認
- [x] **1.4.2** コードレビュー・リファクタリング

---

## Phase 2: 優先順位決定

**目標**: トラックの優先順位決定ロジックの実装
**対応要件**: FR-020, FR-021
**前提**: Phase 1 完了

### 2.1 優先順位計算ロジック

- [x] **2.1.1** Timeline上の位置取得機能の実装
  - `TimelineAsset.GetOutputTracks()` の順序確認
  - テスト作成・実行

- [x] **2.1.2** 優先順位割り当て機能の実装
  - 下にあるトラック = 高優先順位
  - テスト作成・実行

### 2.2 TrackGroup対応

- [x] **2.2.1** GroupTrack内の階層構造解析機能の実装
  - 親グループ・子トラックの関係取得
  - テスト作成・実行

- [x] **2.2.2** 階層構造を含めた優先順位計算の実装
  - テスト作成・実行

### 2.3 Phase 2 完了確認

- [x] **2.3.1** 全テストがパスすることを確認
- [x] **2.3.2** コードレビュー・リファクタリング

---

## Phase 3: 基本的なクリップ統合

**目標**: 単一トラック内のクリップ統合機能の実装
**対応要件**: FR-030, FR-031, FR-064
**前提**: Phase 1 完了

### 3.1 データモデルの作成

- [x] **3.1.1** `ClipInfo.cs` の作成（`Domain/Models/`）
  ```csharp
  // 保持する情報:
  // - TimelineClip参照
  // - AnimationClip参照
  // - 開始時間（double）
  // - 終了時間（double）
  // - ClipIn（トリミング開始位置）
  // - TimeScale
  // - PreExtrapolation設定
  // - PostExtrapolation設定
  // - EaseInDuration
  // - EaseOutDuration
  // - BlendInCurve
  // - BlendOutCurve
  ```

- [x] **3.1.2** `MergeResult.cs` の作成（`Domain/Models/`）
  ```csharp
  // 保持する情報:
  // - 生成されたAnimationClipデータ
  // - バインド先Animator情報
  // - 処理ログ
  ```

- [x] **3.1.3** データモデルの単体テスト作成

### 3.2 ClipMergerの実装

- [x] **3.2.1** `ClipMerger.cs` の作成（`Domain/`）

- [x] **3.2.2** AnimationCurve取得機能の実装
  - AnimationClipから全カーブを取得
  - EditorCurveBinding情報の取得
  - テスト作成・実行

- [x] **3.2.3** 時間オフセット適用機能の実装
  - カーブのキーフレーム時間を調整
  - ClipIn（トリミング）対応
  - TimeScale対応
  - テスト作成・実行

- [x] **3.2.4** カーブ統合機能の実装
  - 複数カーブを単一AnimationClipに統合
  - テスト作成・実行

- [x] **3.2.5** フレームレート設定機能の実装
  - Timeline設定からフレームレート取得
  - AnimationClipへ適用
  - テスト作成・実行

### 3.3 Phase 3 完了確認

- [ ] **3.3.1** 全テストがパスすることを確認
- [ ] **3.3.2** コードレビュー・リファクタリング

---

## Phase 4: Extrapolation処理

**目標**: クリップ間のGapおよびExtrapolation処理の実装
**対応要件**: FR-032, FR-041, FR-042
**前提**: Phase 3 完了

### 4.1 ExtrapolationProcessorの実装

- [x] **4.1.1** `ExtrapolationProcessor.cs` の作成（`Domain/`）

- [x] **4.1.2** None（値なし）処理の実装
  - クリップ範囲外は値を出力しない
  - テスト作成・実行

- [x] **4.1.3** Hold（最終値維持）処理の実装
  - PreExtrapolation: 最初のキーの値を維持
  - PostExtrapolation: 最後のキーの値を維持
  - テスト作成・実行

- [x] **4.1.4** Loop（ループ再生）処理の実装
  - クリップの長さでループ
  - テスト作成・実行

- [x] **4.1.5** PingPong（往復再生）処理の実装
  - クリップの長さで往復
  - テスト作成・実行

- [x] **4.1.6** Continue（傾き維持）処理の実装
  - 最初/最後のキーフレームの接線を延長
  - テスト作成・実行

### 4.2 Gap処理の実装

- [x] **4.2.1** クリップ間Gap検出機能の実装
  - 同一トラック内のクリップ間隔を計算
  - テスト作成・実行

- [x] **4.2.2** Gap区間の補間処理の実装
  - 前のクリップのPostExtrapolation設定を適用
  - テスト作成・実行

### 4.3 Phase 4 完了確認

- [ ] **4.3.1** 全テストがパスすることを確認
- [ ] **4.3.2** コードレビュー・リファクタリング

---

## Phase 5: ブレンド処理

**目標**: EaseIn/EaseOutブレンド処理の実装
**対応要件**: FR-050, FR-051
**前提**: Phase 3 完了

### 5.1 BlendProcessorの実装

- [x] **5.1.1** `BlendProcessor.cs` の作成（`Domain/`）

- [x] **5.1.2** BlendCurve取得機能の実装
  - TimelineClipからBlendInCurve/BlendOutCurve取得
  - EaseInDuration/EaseOutDuration取得
  - テスト作成・実行

- [x] **5.1.3** ブレンドウェイト計算機能の実装
  - 指定時間におけるウェイト値を計算
  - テスト作成・実行

- [ ] **5.1.4** カーブ値ブレンド機能の実装
  - 2つのカーブ値をウェイトで補間
  - テスト作成・実行

- [ ] **5.1.5** 連続クリップのブレンド処理の実装
  - 前のクリップのEaseOutと次のクリップのEaseInの合成
  - テスト作成・実行

### 5.2 Phase 5 完了確認

- [ ] **5.2.1** 全テストがパスすることを確認
- [ ] **5.2.2** コードレビュー・リファクタリング

---

## Phase 6: Override処理

**目標**: 複数トラック間のOverride処理の実装
**対応要件**: FR-040, FR-041
**前提**: Phase 2, Phase 4, Phase 5 完了

### 6.1 CurveOverriderの実装

- [ ] **6.1.1** `CurveOverrider.cs` の作成（`Domain/`）

- [ ] **6.1.2** 同一プロパティ検出機能の実装
  - EditorCurveBindingの比較
  - テスト作成・実行

- [ ] **6.1.3** 完全重なりのOverride処理の実装
  - 高優先順位トラックのカーブで完全に置換
  - テスト作成・実行

- [ ] **6.1.4** 部分的重なりのOverride処理の実装
  - 重なり区間: 高優先順位カーブを使用
  - 非重なり区間: 低優先順位カーブ + Extrapolation設定
  - テスト作成・実行

- [ ] **6.1.5** 複数トラックの統合処理の実装
  - 優先順位順にOverride処理を適用
  - テスト作成・実行

### 6.2 Phase 6 完了確認

- [ ] **6.2.1** 全テストがパスすることを確認
- [ ] **6.2.2** コードレビュー・リファクタリング

---

## Phase 7: 出力機能

**目標**: AnimationClipアセットの保存機能の実装
**対応要件**: FR-060〜FR-063
**前提**: Phase 6 完了

### 7.1 FileNameGeneratorの実装

- [ ] **7.1.1** `FileNameGenerator.cs` の作成（`Infrastructure/`）

- [ ] **7.1.2** 基本ファイル名生成機能の実装
  - 形式: `{TimelineAsset名}_{Animator名}_Merged.anim`
  - テスト作成・実行

- [ ] **7.1.3** 重複回避機能の実装
  - 既存ファイル確認
  - 連番付与: `(1)`, `(2)` ...（スペースなし）
  - テスト作成・実行

### 7.2 AnimationClipExporterの実装

- [ ] **7.2.1** `AnimationClipExporter.cs` の作成（`Infrastructure/`）

- [ ] **7.2.2** AnimationClip作成機能の実装
  - MergeResultからAnimationClipを生成
  - テスト作成・実行

- [ ] **7.2.3** アセット保存機能の実装
  - AssetDatabase.CreateAsset()使用
  - 保存先: Assets/直下
  - テスト作成・実行

### 7.3 Phase 7 完了確認

- [ ] **7.3.1** 全テストがパスすることを確認
- [ ] **7.3.2** コードレビュー・リファクタリング

---

## Phase 8: UI/コンテキストメニュー

**目標**: コンテキストメニューからの実行機能の実装
**対応要件**: FR-001〜FR-003, UX-001, UX-002
**前提**: Phase 7 完了

### 8.1 AnimationMergeServiceの実装

- [ ] **8.1.1** `AnimationMergeService.cs` の作成（`Application/`）

- [ ] **8.1.2** 処理オーケストレーション機能の実装
  - TrackAnalyzer → ClipMerger → ExtrapolationProcessor
  - → BlendProcessor → CurveOverrider → Exporter
  - テスト作成・実行

- [ ] **8.1.3** Animator単位の処理分割機能の実装
  - 複数Animatorがある場合、それぞれ別のAnimationClipを出力
  - テスト作成・実行

### 8.2 ContextMenuHandlerの実装

- [ ] **8.2.1** `ContextMenuHandler.cs` の作成（`UI/`）

- [ ] **8.2.2** Hierarchyビューメニュー登録
  - `[MenuItem("GameObject/Animation Merge Tool/Merge Timeline Animations", ...)]`
  - PlayableDirector選択時のみ有効化
  - テスト作成・実行

- [ ] **8.2.3** Projectビューメニュー登録
  - `[MenuItem("Assets/Animation Merge Tool/Merge Timeline Animations", ...)]`
  - TimelineAsset選択時のみ有効化
  - テスト作成・実行

- [ ] **8.2.4** 複数選択対応の実装
  - Selection.objectsから対象を取得
  - 順次処理を実行
  - テスト作成・実行

### 8.3 ProgressDisplayの実装

- [ ] **8.3.1** `ProgressDisplay.cs` の作成（`UI/`）

- [ ] **8.3.2** 進捗表示機能の実装
  - EditorUtility.DisplayProgressBar()使用
  - テスト作成・実行

- [ ] **8.3.3** 処理結果のConsole出力機能の実装
  - 成功: Debug.Log
  - 失敗: Debug.LogError
  - テスト作成・実行

### 8.4 Phase 8 完了確認

- [ ] **8.4.1** 全テストがパスすることを確認
- [ ] **8.4.2** 統合テストの作成・実行
- [ ] **8.4.3** コードレビュー・リファクタリング

---

## Phase 9: 特殊プロパティ対応

**目標**: ルートモーション・Humanoidマッスルカーブ対応
**対応要件**: FR-070, FR-071
**前提**: Phase 8 完了

### 9.1 ルートモーション対応

- [ ] **9.1.1** ルートモーションプロパティの検出機能の実装
  - RootT, RootQ プロパティの識別
  - テスト作成・実行

- [ ] **9.1.2** ルートモーションカーブの処理機能の実装
  - 通常のカーブと同様に統合
  - テスト作成・実行

### 9.2 Humanoidマッスルカーブ対応

- [ ] **9.2.1** マッスルカーブの検出機能の実装
  - Humanoid Muscle プロパティの識別
  - テスト作成・実行

- [ ] **9.2.2** マッスルカーブの処理機能の実装
  - 通常のカーブと同様に統合
  - テスト作成・実行

### 9.3 Phase 9 完了確認

- [ ] **9.3.1** 全テストがパスすることを確認
- [ ] **9.3.2** コードレビュー・リファクタリング

---

## Phase 10: エラー処理・最終調整

**目標**: エラー処理の強化と全体的な品質向上
**対応要件**: ERR-001, ERR-002
**前提**: Phase 9 完了

### 10.1 エラー処理の強化

- [ ] **10.1.1** ERR-001対応: バインドなしトラックのスキップ処理確認
  - エラーログ出力
  - 処理継続
  - テスト作成・実行

- [ ] **10.1.2** ERR-002対応: 対象トラック0件の処理確認
  - エラーログ出力
  - 処理終了
  - テスト作成・実行

### 10.2 エッジケース対応

- [ ] **10.2.1** 空のTimelineAssetの処理
  - テスト作成・実行

- [ ] **10.2.2** クリップが1つもないトラックの処理
  - テスト作成・実行

- [ ] **10.2.3** 非常に長いタイムラインの処理
  - パフォーマンス確認
  - テスト作成・実行

- [ ] **10.2.4** 大量のカーブを持つAnimationClipの処理
  - パフォーマンス確認
  - テスト作成・実行

### 10.3 最終確認

- [ ] **10.3.1** 全単体テストがパスすることを確認

- [ ] **10.3.2** 全統合テストがパスすることを確認

- [ ] **10.3.3** E2Eテストの作成・実行
  - 実際のTimelineAssetを使用した動作確認
  - コンテキストメニューからの実行テスト

- [ ] **10.3.4** コードカバレッジの確認
  - 目標: 単体テスト80%以上

- [ ] **10.3.5** 最終コードレビュー

- [ ] **10.3.6** 使用方法ドキュメントの作成（必要に応じて）

### 10.4 リリース準備

- [ ] **10.4.1** package.jsonのバージョン番号を確認（初版: `0.1.0-preview.1`）

- [ ] **10.4.2** CHANGELOGの作成（必要に応じて）

- [ ] **10.4.3** 最終動作確認

---

## 補足: テスト用アセット作成ガイド

テストを作成する際に必要となるテスト用アセットの作成方法：

### TimelineAsset作成

```csharp
var timeline = ScriptableObject.CreateInstance<TimelineAsset>();
var track = timeline.CreateTrack<AnimationTrack>(null, "Test Track");
```

### AnimationClip作成

```csharp
var clip = new AnimationClip();
var curve = AnimationCurve.Linear(0, 0, 1, 1);
clip.SetCurve("", typeof(Transform), "localPosition.x", curve);
```

### TimelineClip配置

```csharp
var timelineClip = track.CreateClip<AnimationPlayableAsset>();
timelineClip.start = 0;
timelineClip.duration = 2;
var asset = timelineClip.asset as AnimationPlayableAsset;
asset.clip = animationClip;
```

---

## 更新履歴

| バージョン | 日付 | 変更内容 |
|------------|------|----------|
| 1.0 | 2026-01-25 | 初版作成 |
