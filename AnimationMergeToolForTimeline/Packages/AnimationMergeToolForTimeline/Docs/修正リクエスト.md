# 修正リクエスト

テスト実行結果に基づく修正タスク一覧（574テスト中39失敗）

---

## タスク1: カーブ数のずれを修正

### 概要
多くのテストで期待されるカーブ数と実際に返されるカーブ数が一致しない。テストが1つのプロパティ（例: `localPosition.x`）を期待しているのに、関連するx/y/zコンポーネントが別カーブとして返されている可能性がある。

### 影響範囲
- ClipMergerTests（17テスト失敗）
- AnimationMergeServiceTests（4テスト失敗）
- IntegrationTests（一部）

### 失敗テスト一覧

#### ClipMergerTests
| テスト名 | 期待値 | 実際の値 | ファイル:行 |
|---------|--------|---------|------------|
| GetAnimationCurves_単一のカーブを持つクリップから取得できる | 1 | 3 | ClipMergerTests.cs:72 |
| GetAnimationCurves_異なるパスのカーブを取得できる | 2 | 6 | ClipMergerTests.cs:109 |
| GetAnimationCurves_EditorCurveBinding情報が正しく取得できる | 1 | 3 | ClipMergerTests.cs:131 |
| GetAnimationCurves_カーブのキーフレーム情報が保持される | 1 | 3 | ClipMergerTests.cs:151 |
| GetAnimationCurves_ルートモーションカーブと通常カーブを同時に取得できる | 3 | 5 | ClipMergerTests.cs:1006 |
| GetAnimationCurves_マッスルカーブと通常カーブを同時に取得できる | 2 | 4 | ClipMergerTests.cs:1234 |
| GetAnimationCurve_存在するバインディングのカーブを取得できる | not null | null | ClipMergerTests.cs:200 |
| GetAnimationCurve_正しいパスのバインディングでのみ取得できる | not null | null | ClipMergerTests.cs:218 |
| Merge_単一のClipInfoからカーブを統合できる | 1 | 3 | ClipMergerTests.cs:606 |
| Merge_複数のClipInfoから異なるプロパティのカーブを統合できる | 2 | 3 | ClipMergerTests.cs:643 |
| Merge_同じプロパティのカーブは時間軸上で統合される | 1 | 3 | ClipMergerTests.cs:679 |
| Merge_nullのClipInfoは無視される | 1 | 3 | ClipMergerTests.cs:777 |
| Merge_異なるパスのカーブは別々に統合される | 2 | 6 | ClipMergerTests.cs:812 |
| Merge_同じ時間のキーフレームは後のClipInfoのものが優先される | 1 | 3 | ClipMergerTests.cs:853 |
| Merge_ルートモーションカーブと通常カーブを同時に統合できる | 2 | 4 | ClipMergerTests.cs:1143 |
| Merge_マッスルカーブと通常カーブを同時に統合できる | 2 | 4 | ClipMergerTests.cs:1354 |
| Merge_全身マッスルカーブと指マッスルカーブと通常カーブを同時に統合できる | 4 | 7 | ClipMergerTests.cs:1484 |

#### AnimationMergeServiceTests
| テスト名 | 期待値 | 実際の値 | ファイル:行 |
|---------|--------|---------|------------|
| MergeFromPlayableDirector_Muteトラックはスキップされる | 1 | 3 | AnimationMergeServiceTests.cs:226 |
| MergeFromPlayableDirector_複数Animatorがある場合それぞれ別のAnimationClipを出力する | 1 | 3 | AnimationMergeServiceTests.cs:664 |
| MergeFromPlayableDirector_同一Animatorに複数トラックがバインドされている場合1つのAnimationClipに統合される | 2 | 3 | AnimationMergeServiceTests.cs:747 |

#### IntegrationTests
| テスト名 | 期待値 | 実際の値 | ファイル:行 |
|---------|--------|---------|------------|
| 統合テスト_PlayableDirectorからAnimationClip生成までの全フロー | 2 | 3 | IntegrationTests.cs:100 |
| 統合テスト_優先順位に基づくOverride処理 | 1 | 3 | IntegrationTests.cs:353 |
| 統合テスト_Muteトラックのフィルタリング | 1 | 3 | IntegrationTests.cs:418 |
| E2E_PlayableDirectorから完全なワークフローでAnimationClipが生成保存される | localPosition.yカーブが含まれるべき | 含まれない | IntegrationTests.cs:1219 |
| E2E_ブレンド設定を含むTimelineの処理 | 1 | 3 | IntegrationTests.cs:1500 |

### 調査ポイント
1. テスト側の期待値が正しいか（Unityが内部的にx/y/zを分けて扱うため、3カーブが正しい可能性）
2. 実装側でカーブを過剰に生成していないか
3. テストで使用しているAnimationClipの設定を確認

### 関連ファイル
- `Packages/AnimationMergeToolForTimeline/Tests/Editor/ClipMergerTests.cs`
- `Packages/AnimationMergeToolForTimeline/Tests/Editor/AnimationMergeServiceTests.cs`
- `Packages/AnimationMergeToolForTimeline/Tests/Editor/IntegrationTests.cs`

---

## タスク2: Continue（接線延長）モードの実装修正

### 概要
ExtrapolationProcessor の Continue モードが正しく動作していない。クリップ終了後の接線延長で、傾きに基づく値の外挿が行われていない。

### 影響範囲
- ExtrapolationProcessorTests（10テスト失敗）

### 失敗テスト一覧

| テスト名 | 期待値 | 実際の値 | ファイル:行 |
|---------|--------|---------|------------|
| TryGetExtrapolatedValue_Continueで負の傾きのカーブの場合_正しく延長される | -10 | 0 | ExtrapolationProcessorTests.cs:966 |
| TryGetExtrapolatedValue_ContinueとTimeScaleの組み合わせ | 25 | 20 | ExtrapolationProcessorTests.cs:989 |
| TryGetExtrapolatedValue_ContinueとClipInの組み合わせ | 0 | 5 | ExtrapolationProcessorTests.cs:1012 |
| TryGetExtrapolatedValue_Continue境界での動作確認 | -0.01 | 0 | ExtrapolationProcessorTests.cs:1061 |
| TryGetExtrapolatedValue_ContinueとHoldの違いを確認 | 20 | 10 | ExtrapolationProcessorTests.cs:1096 |
| FillGapWithExtrapolation_PostExtrapolationがContinueの場合はGap区間で接線延長する | 15 | 10 | ExtrapolationProcessorTests.cs:1820 |

### 調査ポイント
1. `TryGetExtrapolatedValue` メソッドでContinueモード時の傾き計算ロジック
2. TimeScaleやClipInとの組み合わせ時の時間変換処理
3. カーブの最終キーフレームからの接線取得方法

### 関連ファイル
- `Packages/AnimationMergeToolForTimeline/Scripts/Editor/Domain/ExtrapolationProcessor.cs`
- `Packages/AnimationMergeToolForTimeline/Tests/Editor/ExtrapolationProcessorTests.cs`

---

## タスク3: PostExtrapolation Hold処理の修正

### 概要
CurveOverriderのPartialOverride処理において、PostExtrapolationがHoldの場合にクリップ終了後の値が正しく維持されていない。高優先順位カーブの最終値ではなく、低優先順位カーブの値が使用されている。

### 影響範囲
- CurveOverriderTests（2テスト失敗）

### 失敗テスト一覧

| テスト名 | 期待値 | 実際の値 | ファイル:行 |
|---------|--------|---------|------------|
| ApplyPartialOverrideWithExtrapolation_PostExtrapolationがHoldの場合_終了後は高優先順位の値を維持 | 200 | 100 | CurveOverriderTests.cs:797 |
| ApplyPartialOverrideWithExtrapolation_両方のExtrapolationがHoldの場合_全区間で高優先順位が有効 | 200 | 100 | CurveOverriderTests.cs:871 |

### 調査ポイント
1. `ApplyPartialOverrideWithExtrapolation` メソッドのPostExtrapolation処理ロジック
2. 高優先順位クリップ終了後の時間範囲で、どのカーブの値を採用するかの判定
3. Extrapolation設定の取得と適用タイミング

### 関連ファイル
- `Packages/AnimationMergeToolForTimeline/Scripts/Editor/Domain/CurveOverrider.cs`
- `Packages/AnimationMergeToolForTimeline/Tests/Editor/CurveOverriderTests.cs`

---

## タスク4: LogAssert.Expect不足の修正

### 概要
テストコードで `Debug.LogError` を出力するメソッドを呼び出しているが、`LogAssert.Expect` で事前宣言されていないためテストが失敗している。

### 影響範囲
- IntegrationTests（1テスト失敗）

### 失敗テスト一覧

| テスト名 | エラー内容 | ファイル:行 |
|---------|-----------|------------|
| 統合テスト_バインドなしトラックのエラー処理 | Unhandled log message: '[Error] [AnimationMergeTool] トラック "UnboundTrack" にAnimatorがバインドされていません。' | IntegrationTests.cs:574 |

### 修正方法
テストコードに以下を追加：
```csharp
LogAssert.Expect(LogType.Error, "[AnimationMergeTool] トラック \"UnboundTrack\" にAnimatorがバインドされていません。");
```

### 関連ファイル
- `Packages/AnimationMergeToolForTimeline/Tests/Editor/IntegrationTests.cs`

---

## 失敗テスト全一覧（39件）

### ClipMergerTests（17件）
1. GetAnimationCurves_単一のカーブを持つクリップから取得できる
2. GetAnimationCurves_異なるパスのカーブを取得できる
3. GetAnimationCurves_EditorCurveBinding情報が正しく取得できる
4. GetAnimationCurves_カーブのキーフレーム情報が保持される
5. GetAnimationCurves_ルートモーションカーブと通常カーブを同時に取得できる
6. GetAnimationCurves_マッスルカーブと通常カーブを同時に取得できる
7. GetAnimationCurve_存在するバインディングのカーブを取得できる
8. GetAnimationCurve_正しいパスのバインディングでのみ取得できる
9. Merge_単一のClipInfoからカーブを統合できる
10. Merge_複数のClipInfoから異なるプロパティのカーブを統合できる
11. Merge_同じプロパティのカーブは時間軸上で統合される
12. Merge_nullのClipInfoは無視される
13. Merge_異なるパスのカーブは別々に統合される
14. Merge_同じ時間のキーフレームは後のClipInfoのものが優先される
15. Merge_ルートモーションカーブと通常カーブを同時に統合できる
16. Merge_マッスルカーブと通常カーブを同時に統合できる
17. Merge_全身マッスルカーブと指マッスルカーブと通常カーブを同時に統合できる

### ExtrapolationProcessorTests（10件）
1. TryGetExtrapolatedValue_Continueで負の傾きのカーブの場合_正しく延長される
2. TryGetExtrapolatedValue_ContinueとTimeScaleの組み合わせ
3. TryGetExtrapolatedValue_ContinueとClipInの組み合わせ
4. TryGetExtrapolatedValue_Continue境界での動作確認
5. TryGetExtrapolatedValue_ContinueとHoldの違いを確認
6. FillGapWithExtrapolation_PostExtrapolationがContinueの場合はGap区間で接線延長する

### IntegrationTests（6件）
1. 統合テスト_PlayableDirectorからAnimationClip生成までの全フロー
2. 統合テスト_優先順位に基づくOverride処理
3. 統合テスト_Muteトラックのフィルタリング
4. 統合テスト_バインドなしトラックのエラー処理
5. E2E_PlayableDirectorから完全なワークフローでAnimationClipが生成保存される
6. E2E_ブレンド設定を含むTimelineの処理

### AnimationMergeServiceTests（4件）
1. MergeFromPlayableDirector_Muteトラックはスキップされる
2. MergeFromPlayableDirector_複数Animatorがある場合それぞれ別のAnimationClipを出力する
3. MergeFromPlayableDirector_同一Animatorに複数トラックがバインドされている場合1つのAnimationClipに統合される

### CurveOverriderTests（2件）
1. ApplyPartialOverrideWithExtrapolation_PostExtrapolationがHoldの場合_終了後は高優先順位の値を維持
2. ApplyPartialOverrideWithExtrapolation_両方のExtrapolationがHoldの場合_全区間で高優先順位が有効
