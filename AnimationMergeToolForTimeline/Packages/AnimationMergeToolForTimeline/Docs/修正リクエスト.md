# テスト修正リクエスト

## 概要

Unity TestRunnerで70件のテストが失敗している問題に対する修正タスク一覧。
各タスクにIDを割り振り、修正方法を記載する。

**テスト結果サマリー:**
- 総テスト数: 574
- 成功: 504
- 失敗: 70

---

## タスク一覧

### TASK-001: BlendProcessor - ブレンド区間前の値取得修正

**対象ファイル:** `Scripts/Editor/Domain/BlendProcessor.cs`

**影響テスト（2件）:**
- `BlendConsecutiveClipValues_ブレンド区間前では前クリップの値を返す`
- `BlendConsecutiveClipQuaternionValues_ブレンド区間前では前クリップの値を返す`

**エラー内容:**
- `Expected: 10.0f, But was: 20.0f`
- `Expected: 0.0d, But was: 0.70710676908493042d`

**修正方法:**
ブレンド区間開始前の時刻では、前クリップの値をそのまま返すようにロジックを修正する。現在は次クリップの値を返してしまっている。

---

### TASK-002: BlendProcessor - ブレンド区間内の補間処理修正

**対象ファイル:** `Scripts/Editor/Domain/BlendProcessor.cs`

**影響テスト（4件）:**
- `BlendConsecutiveClipValues_ブレンド区間内で正しく補間する`
- `BlendConsecutiveClipVector3Values_ブレンド区間内で正しく補間する`
- `BlendConsecutiveClipQuaternionValues_ブレンド区間内で正しく補間する`
- 関連する他のブレンドテスト

**エラー内容:**
- `Expected: less than 20.0f, But was: 20.0f`
- `Expected: less than 10.0f, But was: 10.0f`
- `Expected: less than 90.0f, But was: 90.0f`

**修正方法:**
ブレンド区間内で補間処理が行われていない。ウェイト計算と線形補間（Lerp/Slerp）のロジックを確認・修正する。

---

### TASK-003: BlendProcessor - 残りのブレンド関連テスト修正

**対象ファイル:** `Scripts/Editor/Domain/BlendProcessor.cs`

**影響テスト（4件）:**
- その他のBlendProcessorTests失敗テスト

**修正方法:**
TASK-001, TASK-002の修正後に残る問題があれば対応する。

---

### TASK-004: ClipMerger - GetAnimationCurve カーブ取得修正

**対象ファイル:** `Scripts/Editor/Domain/ClipMerger.cs`

**影響テスト（2件）:**
- `GetAnimationCurve_正しいパスのバインディングでのみ取得できる`
- 関連するカーブ取得テスト

**エラー内容:**
- `Expected: not null, But was: null`

**修正方法:**
`EditorCurveBinding`のパス比較ロジックを確認。正しいパスでカーブを取得できるよう修正する。

---

### TASK-005: ClipMerger - Merge 単一ClipInfo統合処理修正

**対象ファイル:** `Scripts/Editor/Domain/ClipMerger.cs`

**影響テスト（3件）:**
- `Merge_単一のClipInfoからカーブを統合できる`
- `Merge_nullのClipInfoは無視される`
- 関連テスト

**エラー内容:**
- カーブ統合が正しく動作していない

**修正方法:**
単一のClipInfoからカーブを抽出し、結果に統合するロジックを確認・修正する。

---

### TASK-006: ClipMerger - 時間オフセット適用修正

**対象ファイル:** `Scripts/Editor/Domain/ClipMerger.cs`

**影響テスト（2件）:**
- `Merge_時間オフセットが正しく適用される`
- 関連テスト

**修正方法:**
クリップの開始時間に基づく時間オフセット適用ロジックを確認・修正する。

---

### TASK-007: ClipMerger - 残りのMerge関連テスト修正

**対象ファイル:** `Scripts/Editor/Domain/ClipMerger.cs`

**影響テスト（11件）:**
- ClipMergerTestsの残り失敗テスト

**修正方法:**
TASK-004〜006の修正後に残る問題があれば対応する。

---

### TASK-008: ExtrapolationProcessor - Continue モード接線延長修正

**対象ファイル:** `Scripts/Editor/Domain/ExtrapolationProcessor.cs`

**影響テスト（1件）:**
- `FillGapWithExtrapolation_PostExtrapolationがContinueの場合はGap区間で接線延長する`

**エラー内容:**
- `Expected: 15.0d +/- 0.5d, But was: 10.0d`

**修正方法:**
PostExtrapolationがContinueの場合、最後のキーフレームの接線に従って値を延長するロジックを実装・修正する。

---

### TASK-009: ExtrapolationProcessor - 残りのExtrapolation関連テスト修正

**対象ファイル:** `Scripts/Editor/Domain/ExtrapolationProcessor.cs`

**影響テスト（9件）:**
- ExtrapolationProcessorTestsの残り失敗テスト

**修正方法:**
TASK-008の修正後に残る問題があれば対応する。各Extrapolationモード（Hold, Loop, PingPong, Continue, None）の動作を確認。

---

### TASK-010: TrackAnalyzer - GroupTrack内優先順位割り当て修正

**対象ファイル:** `Scripts/Editor/Domain/TrackAnalyzer.cs`

**影響テスト（2件）:**
- `AssignPrioritiesIncludingHierarchy_GroupTrack内のトラックに正しい優先順位を割り当てる`
- `AssignPrioritiesIncludingHierarchy_リスト内の順序に関係なく正しい優先順位が割り当てられる`

**エラー内容:**
- `Expected: True, But was: False`

**修正方法:**
`AssignPrioritiesIncludingHierarchy`メソッドでGroupTrack内のネストされたトラックを再帰的に走査し、正しい優先順位を割り当てるロジックを修正する。

---

### TASK-011: TrackAnalyzer - 残りの優先順位関連テスト修正

**対象ファイル:** `Scripts/Editor/Domain/TrackAnalyzer.cs`

**影響テスト（7件）:**
- TrackAnalyzerTestsの残り失敗テスト

**修正方法:**
TASK-010の修正後に残る問題があれば対応する。

---

### TASK-012: AnimationMergeService - Muteトラックスキップ処理修正

**対象ファイル:** `Scripts/Editor/Application/AnimationMergeService.cs`

**影響テスト（1件）:**
- `MergeFromPlayableDirector_Muteトラックはスキップされる`

**エラー内容:**
- `Expected: 1, But was: 3`

**修正方法:**
Muteフラグが設定されたトラックをフィルタリングするロジックを確認・修正する。`track.muted`プロパティのチェックを追加。

---

### TASK-013: AnimationMergeService - 複数トラック統合処理修正

**対象ファイル:** `Scripts/Editor/Application/AnimationMergeService.cs`

**影響テスト（2件）:**
- `MergeFromPlayableDirector_同一Animatorに複数トラックがバインドされている場合`
- 関連テスト

**修正方法:**
同一Animatorにバインドされた複数トラックのカーブを1つのAnimationClipに統合するロジックを確認・修正する。

---

### TASK-014: AnimationMergeService - 残りのMergeService関連テスト修正

**対象ファイル:** `Scripts/Editor/Application/AnimationMergeService.cs`

**影響テスト（3件）:**
- AnimationMergeServiceTestsの残り失敗テスト

**修正方法:**
TASK-012〜013の修正後に残る問題があれば対応する。

---

### TASK-015: ClipInfo - ClipInプロパティ修正

**対象ファイル:** `Scripts/Editor/Domain/ClipInfo.cs`

**影響テスト（1件）:**
- `ClipIn_TimelineClipのclipInを返す`

**修正方法:**
`ClipInfo`クラスの`ClipIn`プロパティがTimelineClipの`clipIn`値を正しく返すよう修正する。

---

### TASK-016: CurveOverrider - オーバーライド処理修正

**対象ファイル:** `Scripts/Editor/Domain/CurveOverrider.cs`

**影響テスト（2件）:**
- CurveOverriderTestsの失敗テスト

**修正方法:**
カーブの上書き（Override）ロジックを確認・修正する。優先順位に基づいて正しくカーブを上書きする。

---

### TASK-017: AnimationClipExporter - ExportToAssetエラー検証修正

**対象ファイル:** `Scripts/Editor/Infrastructure/AnimationClipExporter.cs`

**影響テスト（1件）:**
- `ExportToAsset_存在しないディレクトリの場合エラーログを追加する`

**エラー内容:**
- `Expected: False, But was: True`

**修正方法:**
テストの期待値またはメソッドの戻り値ロジックを確認・修正する。

---

### TASK-018: IntegrationTests - LogAssert.Expect追加

**対象ファイル:** `Tests/Editor/IntegrationTests.cs`

**影響テスト（1件）:**
- `ERR001_バインドなしトラックがある場合スキップして処理を継続する`

**エラー内容:**
- `Unhandled log message: '[Error] [AnimationMergeTool] トラック "UnboundTrack" にAnimatorがバインドされていません。'`

**修正方法:**
テスト内に以下を追加:
```csharp
LogAssert.Expect(LogType.Error, "[AnimationMergeTool] トラック \"UnboundTrack\" にAnimatorがバインドされていません。");
```

---

### TASK-019: IntegrationTests - E2E PlayableDirectorワークフロー修正

**対象ファイル:** `Tests/Editor/IntegrationTests.cs` および関連ソースファイル

**影響テスト（1件）:**
- `E2E_PlayableDirectorから完全なワークフローでAnimationClipが生成保存される`

**エラー内容:**
- `localPosition.yカーブが含まれるべき Expected: True, But was: False`

**修正方法:**
TASK-004〜007（ClipMerger）の修正後に再確認。テストのセットアップまたはカーブ統合ロジックを確認。

---

### TASK-020: IntegrationTests - E2E TimelineAsset選択実行修正

**対象ファイル:** `Tests/Editor/IntegrationTests.cs` および関連ソースファイル

**影響テスト（1件）:**
- `E2E_TimelineAsset選択からの実行でAnimationClipが生成保存される`

**エラー内容:**
- `AnimationClipアセットが生成されるべき Expected: not null, But was: null`

**修正方法:**
TimelineAssetからの実行フローを確認。AnimationClipが正しく生成・保存されるよう修正。

---

### TASK-021: IntegrationTests - E2E 複雑なTimeline構造処理修正

**対象ファイル:** `Tests/Editor/IntegrationTests.cs` および関連ソースファイル

**影響テスト（1件）:**
- `E2E_複雑なTimeline構造の完全な処理フロー`

**エラー内容:**
- `localPosition.xが含まれるべき Expected: True, But was: False`

**修正方法:**
複数トラック・複数クリップの統合処理を確認。TASK-005〜007の修正後に再確認。

---

### TASK-022: IntegrationTests - E2E ブレンド設定処理修正

**対象ファイル:** `Tests/Editor/IntegrationTests.cs` および関連ソースファイル

**影響テスト（1件）:**
- `E2E_ブレンド設定を含むTimelineの処理`

**エラー内容:**
- `1つのカーブが含まれるべき Expected: 1, But was: 3`

**修正方法:**
TASK-001〜003（BlendProcessor）の修正後に再確認。ブレンド結果のカーブ数が正しいか確認。

---

### TASK-023: IntegrationTests - E2E GroupTrack階層構造処理修正

**対象ファイル:** `Tests/Editor/IntegrationTests.cs` および関連ソースファイル

**影響テスト（1件）:**
- `E2E_GroupTrackを含む階層構造のTimeline処理`

**エラー内容:**
- `2つのカーブが含まれるべき Expected: 2, But was: 3`

**修正方法:**
TASK-010〜011（TrackAnalyzer）の修正後に再確認。GroupTrack内トラックの処理を確認。

---

### TASK-024: IntegrationTests - 統合テスト TimelineAsset実行フロー修正

**対象ファイル:** `Tests/Editor/IntegrationTests.cs` および関連ソースファイル

**影響テスト（1件）:**
- `統合テスト_TimelineAssetからの実行フロー`

**修正方法:**
TimelineAssetからの実行フローを確認・修正。

---

### TASK-025: IntegrationTests - 統合テスト Override処理修正

**対象ファイル:** `Tests/Editor/IntegrationTests.cs` および関連ソースファイル

**影響テスト（1件）:**
- `統合テスト_優先順位に基づくOverride処理`

**修正方法:**
TASK-016（CurveOverrider）の修正後に再確認。優先順位に基づくOverrideロジックを確認。

---

### TASK-026: IntegrationTests - 残りの統合テスト修正

**対象ファイル:** `Tests/Editor/IntegrationTests.cs` および関連ソースファイル

**影響テスト（5件）:**
- `パフォーマンス_大量のカーブを持つAnimationClipの処理`
- その他残りの失敗テスト

**修正方法:**
TASK-001〜025の修正後に残る問題があれば対応する。

---

## タスク依存関係

```
TASK-001, TASK-002 → TASK-003 → TASK-022
TASK-004, TASK-005, TASK-006 → TASK-007 → TASK-019, TASK-021
TASK-008 → TASK-009
TASK-010 → TASK-011 → TASK-023
TASK-012, TASK-013 → TASK-014
TASK-016 → TASK-025
TASK-018〜026は他タスク完了後に再確認
```

---

## 推奨修正順序

1. **Phase 1: 基盤コンポーネント修正**
   - TASK-001〜003 (BlendProcessor) - 10件のテストに影響
   - TASK-004〜007 (ClipMerger) - 18件のテストに影響
   - TASK-008〜009 (ExtrapolationProcessor) - 10件のテストに影響

2. **Phase 2: 分析・サービス層修正**
   - TASK-010〜011 (TrackAnalyzer) - 9件のテストに影響
   - TASK-012〜014 (AnimationMergeService) - 6件のテストに影響

3. **Phase 3: 個別修正**
   - TASK-015 (ClipInfo) - 1件
   - TASK-016 (CurveOverrider) - 2件
   - TASK-017 (AnimationClipExporter) - 1件

4. **Phase 4: 統合テスト修正**
   - TASK-018〜026 (IntegrationTests) - 13件

---

## テスト実行コマンド

```bash
# EditMode テストの実行
"C:\Program Files\Unity\Hub\Editor\6000.0.64f1\Editor\Unity.exe" -batchmode -projectPath "./AnimationMergeToolForTimeline" -runTests -testPlatform EditMode -testResults "./EditModeTestResults.xml"
```

---

## サマリー

| タスクID | 対象 | 影響テスト数 | 優先度 |
|----------|------|-------------|--------|
| TASK-001〜003 | BlendProcessor | 10 | 高 |
| TASK-004〜007 | ClipMerger | 18 | 高 |
| TASK-008〜009 | ExtrapolationProcessor | 10 | 高 |
| TASK-010〜011 | TrackAnalyzer | 9 | 中 |
| TASK-012〜014 | AnimationMergeService | 6 | 中 |
| TASK-015 | ClipInfo | 1 | 低 |
| TASK-016 | CurveOverrider | 2 | 低 |
| TASK-017 | AnimationClipExporter | 1 | 低 |
| TASK-018〜026 | IntegrationTests | 13 | 低（他タスク完了後） |

**合計: 26タスク / 70件の失敗テスト**
