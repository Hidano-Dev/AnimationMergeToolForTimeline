# テスト修正リクエスト

## 概要

Unity TestRunnerで93件のテストが失敗していた問題に対する修正作業のドキュメント。
本作業で23件を修正し、残り70件の失敗テストが残存している。

## 修正済み項目

### FIX-001: AnimationClipExporterTests - using追加

**ファイル**: `Packages/AnimationMergeToolForTimeline/Tests/Editor/AnimationClipExporterTests.cs`

**修正内容**: `using UnityEngine.TestTools;` を追加

---

### FIX-002: AnimationClipExporterTests - CreateAnimationClip_MergeResultがnullの場合

**ファイル**: `Packages/AnimationMergeToolForTimeline/Tests/Editor/AnimationClipExporterTests.cs`

**修正内容**: `LogAssert.Expect(LogType.Error, "MergeResultがnullです。");` を追加

---

### FIX-003: AnimationClipExporterTests - CreateAnimationClip_MergeResult不要版_カーブリストがnullの場合

**ファイル**: `Packages/AnimationMergeToolForTimeline/Tests/Editor/AnimationClipExporterTests.cs`

**修正内容**: `LogAssert.Expect(LogType.Error, "カーブデータが空のためAnimationClipを生成できません。");` を追加

---

### FIX-004: AnimationClipExporterTests - CreateAnimationClip_MergeResult不要版_カーブリストが空の場合

**ファイル**: `Packages/AnimationMergeToolForTimeline/Tests/Editor/AnimationClipExporterTests.cs`

**修正内容**: `LogAssert.Expect(LogType.Error, "カーブデータが空のためAnimationClipを生成できません。");` を追加

---

### FIX-005: AnimationClipExporterTests - SaveAsAsset_clipがnullの場合

**ファイル**: `Packages/AnimationMergeToolForTimeline/Tests/Editor/AnimationClipExporterTests.cs`

**修正内容**: `LogAssert.Expect(LogType.Error, "保存するAnimationClipがnullです。");` を追加

---

### FIX-006: AnimationClipExporterTests - SaveAsAsset_存在しないディレクトリの場合

**ファイル**: `Packages/AnimationMergeToolForTimeline/Tests/Editor/AnimationClipExporterTests.cs`

**修正内容**: `LogAssert.Expect(LogType.Error, "保存先ディレクトリが存在しません: Assets/NonExistentFolder12345");` を追加

---

### FIX-007: AnimationClipExporterTests - ExportToAsset_存在しないディレクトリの場合

**ファイル**: `Packages/AnimationMergeToolForTimeline/Tests/Editor/AnimationClipExporterTests.cs`

**修正内容**: `LogAssert.Expect(LogType.Error, "保存先ディレクトリが存在しません: Assets/NonExistentFolder12345");` を追加

---

### FIX-008: AnimationMergeServiceTests - using追加

**ファイル**: `Packages/AnimationMergeToolForTimeline/Tests/Editor/AnimationMergeServiceTests.cs`

**修正内容**: `using UnityEngine.TestTools;` を追加

---

### FIX-009: AnimationMergeServiceTests - MergeFromPlayableDirector_PlayableDirectorがnullの場合

**ファイル**: `Packages/AnimationMergeToolForTimeline/Tests/Editor/AnimationMergeServiceTests.cs`

**修正内容**: `LogAssert.Expect(LogType.Error, "[AnimationMergeTool] PlayableDirectorがnullです。");` を追加

---

### FIX-010: AnimationMergeServiceTests - MergeFromPlayableDirector_TimelineAssetが未設定の場合

**ファイル**: `Packages/AnimationMergeToolForTimeline/Tests/Editor/AnimationMergeServiceTests.cs`

**修正内容**: `LogAssert.Expect(LogType.Error, "[AnimationMergeTool] PlayableDirectorにTimelineAssetが設定されていません。");` を追加

---

### FIX-011: AnimationMergeServiceTests - MergeFromPlayableDirector_バインドされたAnimatorがない場合

**ファイル**: `Packages/AnimationMergeToolForTimeline/Tests/Editor/AnimationMergeServiceTests.cs`

**修正内容**:
```csharp
LogAssert.Expect(LogType.Error, "[AnimationMergeTool] トラック \"TestTrack\" にAnimatorがバインドされていません。");
LogAssert.Expect(LogType.Error, "[AnimationMergeTool] バインドされたAnimatorが見つかりません。");
```

---

### FIX-012: AnimationMergeServiceTests - MergeFromPlayableDirector_対象トラック0件の場合

**ファイル**: `Packages/AnimationMergeToolForTimeline/Tests/Editor/AnimationMergeServiceTests.cs`

**修正内容**:
```csharp
LogAssert.Expect(LogType.Error, "[AnimationMergeTool] トラック \"UnboundTrack\" にAnimatorがバインドされていません。");
LogAssert.Expect(LogType.Error, "[AnimationMergeTool] バインドされたAnimatorが見つかりません。");
```

---

### FIX-013: AnimationMergeServiceTests - MergeFromPlayableDirector_空のTimelineAssetがバインドされている場合

**ファイル**: `Packages/AnimationMergeToolForTimeline/Tests/Editor/AnimationMergeServiceTests.cs`

**修正内容**: `LogAssert.Expect(LogType.Error, "[AnimationMergeTool] バインドされたAnimatorが見つかりません。");` を追加

---

### FIX-014: AnimationMergeServiceTests - MergeFromTimelineAsset_TimelineAssetがnullの場合

**ファイル**: `Packages/AnimationMergeToolForTimeline/Tests/Editor/AnimationMergeServiceTests.cs`

**修正内容**: `LogAssert.Expect(LogType.Error, "[AnimationMergeTool] TimelineAssetがnullです。");` を追加

---

### FIX-015: AnimationMergeServiceTests - MergeFromTimelineAsset_AnimationTrackがない場合空のリストを返す

**ファイル**: `Packages/AnimationMergeToolForTimeline/Tests/Editor/AnimationMergeServiceTests.cs`

**修正内容**: `LogAssert.Expect(LogType.Error, "[AnimationMergeTool] 有効なAnimationTrackが見つかりません。");` を追加

---

### FIX-016: AnimationMergeServiceTests - MergeFromTimelineAsset_全てのトラックがMuteの場合

**ファイル**: `Packages/AnimationMergeToolForTimeline/Tests/Editor/AnimationMergeServiceTests.cs`

**修正内容**: `LogAssert.Expect(LogType.Error, "[AnimationMergeTool] 有効なAnimationTrackが見つかりません。");` を追加

---

### FIX-017: AnimationMergeServiceTests - MergeFromTimelineAsset_有効なトラック0件の場合

**ファイル**: `Packages/AnimationMergeToolForTimeline/Tests/Editor/AnimationMergeServiceTests.cs`

**修正内容**: `LogAssert.Expect(LogType.Error, "[AnimationMergeTool] 有効なAnimationTrackが見つかりません。");` を追加

---

### FIX-018: AnimationMergeServiceTests - MergeFromTimelineAsset_AnimationTrackがない場合エラーログを出力して処理終了する

**ファイル**: `Packages/AnimationMergeToolForTimeline/Tests/Editor/AnimationMergeServiceTests.cs`

**修正内容**: `LogAssert.Expect(LogType.Error, "[AnimationMergeTool] 有効なAnimationTrackが見つかりません。");` を追加

---

### FIX-019: 他のテストファイル - using追加

**対象ファイル**:
- `Packages/AnimationMergeToolForTimeline/Tests/Editor/BlendProcessorTests.cs`
- `Packages/AnimationMergeToolForTimeline/Tests/Editor/ClipMergerTests.cs`
- `Packages/AnimationMergeToolForTimeline/Tests/Editor/ClipInfoTests.cs`
- `Packages/AnimationMergeToolForTimeline/Tests/Editor/ContextMenuHandlerTests.cs`
- `Packages/AnimationMergeToolForTimeline/Tests/Editor/CurveOverriderTests.cs`
- `Packages/AnimationMergeToolForTimeline/Tests/Editor/ExtrapolationProcessorTests.cs`
- `Packages/AnimationMergeToolForTimeline/Tests/Editor/IntegrationTests.cs`
- `Packages/AnimationMergeToolForTimeline/Tests/Editor/TrackAnalyzerTests.cs`

**修正内容**: 各ファイルに `using UnityEngine.TestTools;` を追加

---

### FIX-020: ContextMenuHandlerTests - ExecuteForPlayableDirectors_nullの場合

**ファイル**: `Packages/AnimationMergeToolForTimeline/Tests/Editor/ContextMenuHandlerTests.cs`

**修正内容**: `LogAssert.Expect(LogType.Error, "[AnimationMergeTool] 処理対象のPlayableDirectorがありません。");` を追加

---

### FIX-021: ContextMenuHandlerTests - ExecuteForPlayableDirectors_空配列の場合

**ファイル**: `Packages/AnimationMergeToolForTimeline/Tests/Editor/ContextMenuHandlerTests.cs`

**修正内容**: `LogAssert.Expect(LogType.Error, "[AnimationMergeTool] 処理対象のPlayableDirectorがありません。");` を追加

---

### FIX-022: ContextMenuHandlerTests - ExecuteForTimelineAssets_nullの場合

**ファイル**: `Packages/AnimationMergeToolForTimeline/Tests/Editor/ContextMenuHandlerTests.cs`

**修正内容**: `LogAssert.Expect(LogType.Error, "[AnimationMergeTool] 処理対象のTimelineAssetがありません。");` を追加

---

### FIX-023: ContextMenuHandlerTests - ExecuteForTimelineAssets_空配列の場合

**ファイル**: `Packages/AnimationMergeToolForTimeline/Tests/Editor/ContextMenuHandlerTests.cs`

**修正内容**: `LogAssert.Expect(LogType.Error, "[AnimationMergeTool] 処理対象のTimelineAssetがありません。");` を追加

---

### FIX-024: IntegrationTests - 統合テスト_空のTimelineAssetのエラー処理

**ファイル**: `Packages/AnimationMergeToolForTimeline/Tests/Editor/IntegrationTests.cs`

**修正内容**: `LogAssert.Expect(LogType.Error, "[AnimationMergeTool] 有効なAnimationTrackが見つかりません。");` を追加

---

### FIX-025: TrackAnalyzerTests - DetectUnboundTracks_BoundAnimatorがnullのトラックを検出する

**ファイル**: `Packages/AnimationMergeToolForTimeline/Tests/Editor/TrackAnalyzerTests.cs`

**修正内容**:
```csharp
LogAssert.Expect(LogType.Error, "[AnimationMergeTool] トラック \"Track 1\" にAnimatorがバインドされていません。");
LogAssert.Expect(LogType.Error, "[AnimationMergeTool] トラック \"Track 2\" にAnimatorがバインドされていません。");
```

---

### FIX-026: TrackAnalyzerTests - DetectUnboundTracks_BoundAnimatorが設定されているトラックは含まない

**ファイル**: `Packages/AnimationMergeToolForTimeline/Tests/Editor/TrackAnalyzerTests.cs`

**修正内容**: `LogAssert.Expect(LogType.Error, "[AnimationMergeTool] トラック \"Track 2\" にAnimatorがバインドされていません。");` を追加

---

### FIX-027: TrackAnalyzerTests - DetectUnboundTracks_nullのTrackInfoは除外される

**ファイル**: `Packages/AnimationMergeToolForTimeline/Tests/Editor/TrackAnalyzerTests.cs`

**修正内容**: `LogAssert.Expect(LogType.Error, "[AnimationMergeTool] トラック \"Track 1\" にAnimatorがバインドされていません。");` を追加

---

## 未修正項目（残り70件）

### 失敗テストの内訳

| テストクラス | 失敗数 | 主な原因 |
|-------------|--------|---------|
| AnimationClipExporterTests | 1 | アサーションエラー |
| AnimationMergeServiceTests | 6 | アサーションエラー/LogAssert |
| BlendProcessorTests | 10 | アサーションエラー（補間値の不一致） |
| ClipInfoTests | 1 | アサーションエラー |
| ClipMergerTests | 18 | アサーションエラー/LogAssert |
| CurveOverriderTests | 2 | アサーションエラー |
| ExtrapolationProcessorTests | 10 | アサーションエラー |
| IntegrationTests | 13 | アサーションエラー/LogAssert |
| TrackAnalyzerTests | 9 | アサーションエラー/LogAssert |

---

### PENDING-001: AnimationMergeServiceTests - MergeFromPlayableDirector_Muteトラックはスキップされる

**エラー内容**: `Expected: 1 But was: 3`

**原因**: Muteトラックのフィルタリングロジックまたはテストの期待値の問題

---

### PENDING-002: AnimationMergeServiceTests - MergeFromPlayableDirector_同一Animatorに複数トラックがバインドされている場合

**エラー内容**: `Expected: 2 But was: X`（両方のカーブが1つのクリップに統合されるべき）

**原因**: 複数トラックの統合ロジックの問題

---

### PENDING-003: BlendProcessorTests - BlendConsecutiveClipValues_ブレンド区間前では前クリップの値を返す

**エラー内容**: `Expected: 10.0f But was: 20.0f`

**原因**: ブレンド区間の判定ロジックまたは補間処理の問題

---

### PENDING-004: BlendProcessorTests - BlendConsecutiveClipValues_ブレンド区間内で正しく補間する

**エラー内容**: `Expected: less than 20.0f But was: 20.0f`

**原因**: 補間処理が正しく動作していない

---

### PENDING-005: BlendProcessorTests - BlendConsecutiveClipVector3Values_ブレンド区間内で正しく補間する

**エラー内容**: `Expected: less than 10.0f But was: 10.0f`

**原因**: Vector3の補間処理が正しく動作していない

---

### PENDING-006: BlendProcessorTests - BlendConsecutiveClipQuaternionValues_ブレンド区間前では前クリップの値を返す

**エラー内容**: `Expected: 0.0d +/- 9.9999997473787516E-05d But was: 0.70710676908493042d`

**原因**: Quaternionの補間処理の問題

---

### PENDING-007: BlendProcessorTests - BlendConsecutiveClipQuaternionValues_ブレンド区間内で正しく補間する

**エラー内容**: `Expected: less than 90.0f But was: 90.0f`

**原因**: Quaternionの補間処理が正しく動作していない

---

### PENDING-008: ClipInfoTests - ClipIn_TimelineClipのclipInを返す

**エラー内容**: アサーションエラー

**原因**: ClipInfoのclipInプロパティの実装問題

---

### PENDING-009: ClipMergerTests - 複数のテストが失敗（18件）

**主なエラー内容**:
- `Merge_単一のClipInfoからカーブを統合できる`
- `Merge_時間オフセットが正しく適用される`
- `Merge_nullのClipInfoは無視される`

**原因**: ClipMergerの統合ロジックまたはテストセットアップの問題

---

### PENDING-010: CurveOverriderTests - 2件の失敗

**原因**: Override処理のロジックの問題

---

### PENDING-011: ExtrapolationProcessorTests - 10件の失敗

**原因**: Extrapolation（外挿）処理のロジックの問題

---

### PENDING-012: IntegrationTests - 13件の失敗

**主なテスト**:
- `E2E_GroupTrackを含む階層構造のTimeline処理`
- `E2E_ブレンド設定を含むTimelineの処理`
- `E2E_複雑なTimeline構造の完全な処理フロー`
- `統合テスト_Muteトラックのフィルタリング`
- `統合テスト_TimelineAssetからの実行フロー`
- `統合テスト_優先順位に基づくOverride処理`

**原因**: 各コンポーネントの連携問題または個別のロジックエラー

---

### PENDING-013: TrackAnalyzerTests - 9件の失敗

**主なエラー内容**:
- `AssignPrioritiesIncludingHierarchy_リスト内の順序に関係なく正しい優先順位が割り当てられる` - `Expected: True But was: False`
- その他LogAssert関連

**原因**: 優先順位割り当てロジックの問題

---

## 修正パターンの説明

### パターン1: LogAssert.Expectの追加

Unity Test Frameworkでは、テスト中に`Debug.LogError`が呼ばれた場合、事前に`LogAssert.Expect`で宣言しないとテストが失敗する。

**修正前**:
```csharp
[Test]
public void SomeTest()
{
    // エラーログを出力するメソッドを呼び出す
    var result = SomeMethod(null);
    Assert.IsNull(result);
}
```

**修正後**:
```csharp
[Test]
public void SomeTest()
{
    // エラーログを期待
    LogAssert.Expect(LogType.Error, "期待されるエラーメッセージ");

    // エラーログを出力するメソッドを呼び出す
    var result = SomeMethod(null);
    Assert.IsNull(result);
}
```

### パターン2: using文の追加

`LogAssert`を使用するには、`using UnityEngine.TestTools;`が必要。

---

## テスト実行コマンド

```bash
# EditMode テストの実行
"C:\Program Files\Unity\Hub\Editor\6000.0.64f1\Editor\Unity.exe" -batchmode -projectPath "./AnimationMergeToolForTimeline" -runTests -testPlatform EditMode -testResults "./TestResults.xml"
```

---

## 修正前後の比較

| 状態 | 修正前 | 修正後 |
|------|--------|--------|
| 成功 | 481 | 504 |
| 失敗 | 93 | 70 |
| 修正数 | - | 23 |
